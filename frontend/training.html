<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>多人动作评分 · 实验准备</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 16px;
        }

        .wrap {
            width: 100%;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .meta {
            color: #666;
            margin-bottom: 16px;
        }

        /* 两列布局：左侧目录窄，右侧内容宽 */
        .layout {
            display: grid;
            grid-template-columns:160px 1fr;
            gap: 16px;
        }

        /* 侧边目录 */
        .sidebar {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .sidebar header {
            padding: 10px 12px;
            background: #f7f7f7;
            font-weight: 600;
        }

        .sidebar .list {
            max-height: calc(100vh - 150px);
            overflow: auto;
            padding: 8px;
        }

        .idxbtn {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            border: 1px solid #eee;
            background: #fff;
            color: #000;
            border-radius: 6px;
            margin: 4px 0;
            cursor: pointer;
            font-size: 14px;
        }

        .idxbtn.active {
            outline: 2px solid #222;
        }

        .idxbtn.done {
            background: #e9f7ef;
            border-color: #bfe7cf;
        }

        /* 完成=绿色 */

        /* 视频区域更大，便于观看 */
        .video-grid {
            display: grid;
            grid-template-columns:1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }

        video {
            width: 100%;
            height: auto;
            max-height: 420px;
            background: #000;
        }

        .prompt-box {
            background: #fafafa;
            border: 1px solid #eee;
            padding: 12px;
            margin: 12px 0 18px;
            white-space: pre-wrap;
        }

        .muted {
            color: #777;
            font-size: 13px;
        }

        .matrix {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .matrix table {
            width: 100%;
            border-collapse: collapse;
        }

        .matrix th, .matrix td {
            border-bottom: 1px solid #eee;
            text-align: center;
            padding: 10px;
        }

        .matrix tr:last-child td {
            border-bottom: none;
        }

        .matrix thead th {
            background: #f7f7f7;
            font-weight: 600;
            color: #444;
        }

        .rowlabel {
            text-align: left;
            width: 240px;
            color: #444;
        }

        .avgbox {
            margin: 8px 0;
            font-weight: 600;
        }

        /* 评分标准表 */
        .std-table {
            width: 100%;
            border-collapse: collapse;
        }

        .std-table th, .std-table td {
            border: 1px solid #ddd;
            padding: 10px;
            vertical-align: top;
        }

        .std-table thead th {
            background: #f2f2f2;
        }

        .std-ename {
            color: #888;
            font-size: 12px;
            font-weight: normal;
            margin-left: 6px;
        }

        .cta {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            background: #222;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        /* 示例评分解析 */
        .analysis-box {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
            background: #fcfcfc;
        }

        .analysis-box h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .analysis-box ul {
            margin: 0;
            padding-left: 18px;
        }

        .analysis-box li {
            margin: 6px 0;
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1>多人动作评分 · 实验准备</h1>
    <div class="meta" id="metaInfo">请先阅读评分标准与注意事项，并阅读 5
        个典型示例；完成后进行共识测试并下载数据，再进入正式评分。
    </div>

    <div class="layout">
        <!-- 左侧目录 -->
        <aside class="sidebar">
            <header>培训目录</header>
            <div class="list" id="idxList"></div>
        </aside>

        <!-- 右侧主体 -->
        <main id="main"><!-- 动态渲染 --></main>
    </div>
</div>

<script>
    (function () {
        const params = new URLSearchParams(location.search);
        const user = params.get('user') || 'user_001';

        // 页面清单：先放“评分标准 + 6个示例”，其余等数据加载后再 push
        const pages = [
            {type: 'welcome', title: '欢迎'},
            {type: 'standard', title: '评分标准表'},
            {type: 'notice', title: '注意事项'},
            {type: 'sample', title: '示例 1'},
            {type: 'sample', title: '示例 2'},
            {type: 'sample', title: '示例 3'},
            {type: 'sample', title: '示例 4'},
            {type: 'sample', title: '示例 5'},
        ];


        const els = {
            idxList: document.getElementById('idxList'),
            main: document.getElementById('main'),
            meta: document.getElementById('metaInfo')
        };

        let samples = [];     // data/training_samples.json
        let prompts = {};     // data/prompts_bi.json
        let consensus = [];   // data/consensus_test.json

        let current = 0;

        // —— 共识测试评分：本地续存（跨重启不丢）
        const CONS_KEY = `consensus_${user}`;
        const consResults = new Map(); // video_id -> {video_id,s1..s4,avg,saved_at}

        // 渲染侧边目录（带进度着色）
        function renderIndex() {
            const frag = document.createDocumentFragment();
            pages.forEach((p, idx) => {
                const b = document.createElement('button');
                b.className = 'idxbtn' + (idx === current ? ' active' : '');
                b.textContent = `${idx + 1}. ${p.title}`;

                // 对“共识测试题页”做完成着色
                if (p.type === 'cons_task') {
                    const item = consensus[p.idx];
                    if (item && consResults.has(item.video_id)) {
                        b.classList.add('done');
                    }
                }

                b.addEventListener('click', () => load(idx));
                frag.appendChild(b);
            });
            els.idxList.innerHTML = '';
            els.idxList.appendChild(frag);
        }

        function setActive(idx) {
            const btns = els.idxList.querySelectorAll('.idxbtn');
            btns.forEach((b, i) => b.classList.toggle('active', i === idx));
        }

        function updateIndexDoneStates() {
            // 动态为已完成的共识题加 done
            const btns = els.idxList.querySelectorAll('.idxbtn');
            pages.forEach((p, idx) => {
                if (p.type === 'cons_task') {
                    const item = consensus[p.idx];
                    btns[idx]?.classList.toggle('done', !!(item && consResults.has(item.video_id)));
                }
            });
        }

        // 顶部 meta 文案：在共识环节显示进度，其它环节显示培训进度
        function updateMeta() {
            const p = pages[current];
            if (p.type === 'cons_task' || p.type === 'cons_intro' || p.type === 'cons_export') {
                els.meta.innerHTML = `共识测试进度：<strong>${consResults.size}/${consensus.length}</strong>（已完成/总数）。`;
            } else {
                els.meta.textContent = '请先阅读评分标准，并参考 5 个示例；完成后进行共识测试并下载数据，再进入正式评分。';
            }
        }

        // —— 欢迎页面
        function renderWelcome() {
            els.main.innerHTML = `
    <h2>欢迎参加「多人动作评分」实验</h2>
    <p>感谢你参与本次研究！本实验旨在评估与改进多人动作生成模型的感知质量。目标是让模型生成的动作更自然、更流畅且更符合人类直觉与生理常识，尤其是在多人互动场景中的配合与空间合理性。</p>

    <h3>实验流程</h3>
    <ol>
      <li><strong>评分标准表：</strong>先了解四个评分维度及其 1–5 分的定义。</li>
      <li><strong>注意事项：</strong>了解保存方式、浏览器要求与数据备份。</li>
      <li><strong>示例学习：</strong>观看若干示例（双视角），对照我们给出的示例评分与解析，快速熟悉标准。</li>
      <li><strong>共识测试：</strong>完成共识测试，这是一组统一的小规模题目，并下载保存 CSV 结果。</li>
      <li><strong>正式评分：</strong>进入正式任务，对分配给你的动作样本进行评分并导出 CSV。</li>
    </ol>

    <h3>我们的研究与数据集贡献</h3>
    <p>现有自动指标与人类感知并不完全一致，难以全面反映动作质量。本研究通过大规模人类感知反馈建立数据集，并训练<strong>人感知对齐的动作评论模型（MotionCritic）</strong>，使其作为更符合人类判断的质量度量，并可用作生成模型的轻量监督信号，以提升生成质量。你的评分将直接帮助我们构建<strong>多人动作</strong>的感知数据，为未来的动作生成研究与评测提供更可靠的参考。</p>

    <p><em>再次感谢你的参与！你的认真评分将帮助学界更准确地评价和改进动作生成模型。</em></p>

    <div class="cta">
      <button class="btn" id="toNext">下一页：评分标准表</button>
    </div>
  `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }


        // —— 评分标准表（来自你的文档，网页化展示）——
        function renderStandard() {
            els.main.innerHTML = `
    <h2>评分标准表</h2>
    <table class="std-table">
      <thead>
        <tr>
          <th>评分维度</th>
          <th>1 分</th><th>2 分</th><th>3 分</th><th>4 分</th><th>5 分</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>动作自然性 <span class="std-ename">Motion Naturalness</span></td>
          <td>明显不自然、断裂/跳变、严重抖动（像机器人）。</td>
          <td>局部僵硬、过渡不连贯，偶有异常姿势。</td>
          <td>整体尚自然，轻微不协调可接受。</td>
          <td>流畅协调，基本符合生理逻辑。</td>
          <td>极度自然、连续平滑、细节丰富。</td>
        </tr>
        <tr>
          <td>多人互动清晰度 <span class="std-ename">Interaction Clarity</span></td>
          <td>几乎无互动或互动模糊，意图不可辨。</td>
          <td>有互动迹象但配合不足，目标模糊。</td>
          <td>互动结构可辨，部分回应不到位。</td>
          <td>互动明确、配合良好，有因果链。</td>
          <td>高度清晰、连贯，回应紧密。</td>
        </tr>
        <tr>
          <td>空间合理性与穿插控制 <span class="std-ename">Spatial Plausibility & Penetration</span></td>
          <td>多次明显穿插/重叠/错位。</td>
          <td>偶有穿插，站位常不合理。</td>
          <td>少量穿插（多见复杂动作），整体可接受。</td>
          <td>空间自然、距离恰当，无明显穿插。</td>
          <td>完全无穿插，空间布局精准自然。</td>
        </tr>
        <tr>
          <td>场景契合度 <span class="std-ename">Scene / Prompt Relevance</span></td>
          <td>与描述严重不符，语义缺失明显。</td>
          <td>部分契合但总体偏离主题。</td>
          <td>大致符合，关键点不够到位。</td>
          <td>高度一致，语义清晰到位。</td>
          <td>精确匹配且富有节奏/情绪张力。</td>
        </tr>
      </tbody>
    </table>

    <!-- ★ 新增：评分维度详细解释（来自你的文档，精炼呈现） -->
    <div class="analysis-box" style="margin-top:16px">
      <h3>评分维度详细解释(仅供参考)</h3>

      <h4>1) 动作自然性（只评价动作本身的生物学合理性与流畅性）</h4>
      <ul>
        <li><strong>看点：</strong>是否“有意图的运动”；关节转动是否合逻辑；过渡是否平滑。</li>
        <li><strong>常见扣分：</strong>断裂/突然跳变；严重抖动（头部轻微抖动可宽容）；僵硬像木偶；脚步平移无屈膝；随机挥舞。</li>
        <li><strong>加分线索：</strong>连贯顺滑、姿势自然；手臂随动/转头等细节；整体接近真人演示。</li>
        <li><strong>注意：</strong>根据不自然程度来判断，例如：轻微的抖动可以只扣一分</li>
      </ul>

      <h4>2) 多人互动清晰度（是否能看出明确互动或良好区分）</h4>
      <ul>
        <li><strong>看点：</strong>面对面/攻防/传接等是否清晰，有无因果链或配合关系。</li>
        <li><strong>常见扣分：</strong>应有互动却“各跳各的”；有对视无回应；不知谁与谁互动。</li>
        <li><strong>加分线索：</strong>“攻击–闪避”“握手”“传–接”等明确响应；无需互动的场景下，两人动作也清楚不干扰。</li>
        <li><strong>注意：</strong>Prompt 不要求互动时，不要强行打低分；具体例子请看示例一说明</li>
      </ul>

      <h4>3) 空间合理性与穿插控制（距离/站位/是否穿插）</h4>
      <ul>
        <li><strong>看点：</strong>对打/舞蹈的安全距离与间隔；角色之间是否穿插、重叠、错位。</li>
        <li><strong>常见扣分：</strong>手臂穿过身体/对方；身体重叠；脚插地或插对方；位置极不合理；频繁穿插。</li>
        <li><strong>加分线索：</strong>距离合适、布局自然；完全无穿插；协调程度像真实表演。</li>
        <li><strong>注意：</strong>复杂动作少量穿插可接受（≈3 分）；若整体合理仅个别手指/脚尖轻微穿插，可从 4 调至 3，不必过重惩罚；两个角色距离的过远或过近都可扣分</li>
      </ul>

      <h4>4) 场景契合度（是否符合文本描述/角色分工）</h4>
      <ul>
        <li><strong>看点：</strong>动作是否与描述一致，是否避免与 prompt 冲突；多要素是否分别落实。</li>
        <li><strong>常见扣分：</strong>严重不符（如“跳舞”→在走路）；只完成部分语义；两人混乱（本应甲做的动作却乙也做/做错人）。</li>
        <li><strong>加分线索：</strong>覆盖主要语义点；关键动作一目了然；还体现节奏/情绪张力、沉浸感强。</li>
        <li><strong>注意：</strong>与自然性独立：自然不代表契合；多要素要逐一检查是否到位。</li>
      </ul>

      <h4>评审提醒</h4>
      <p>四个维度<strong>相互独立</strong>。请不要被“整体感觉”带偏：</p>
      <ul>
        <li>自然性 = 5，但无互动 → 互动清晰度仍应打低分（如 1）。</li>
        <li>契合度 = 5，但有严重穿插 → 空间合理性应打低分（如 1）。</li>
      </ul>
      <p>你的任务是 在每个维度上独立判断并打分，而不是做一个“总印象分”</p>
    </div>

    <div class="cta">
      <button class="btn" id="toNext">下一页：注意事项</button>
    </div>
  `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }

        //注意事项页面
        function renderNotice() {
            els.main.innerHTML = `
    <h2>注意事项</h2>
    <ol>
      <li>关于动作的描述文本：页面提供了中英文双语说明。中文部分为机器翻译，可能存在不准确之处，请以英文文本为准。</li>
      <li>在完成每个样本的评分后，请务必点击 <strong>“保存当前评分”</strong> 按钮，以确保结果被正确保存。</li>
      <li>实验过程中，你的评分结果会保存在本地浏览器中。你可以随时关闭页面或电脑，数据不会丢失。但请不要清除浏览器记录，也不要在无痕模式下访问实验网站。</li>
      <li>完成共识测试后，请下载并妥善保存生成的 CSV 文件作为备份。在完成正式实验后，同样需要下载并妥善保存正式实验结果的 CSV 文件。</li>
    </ol>
    <div class="cta">
      <button class="btn" id="toNext">下一页：示例 1</button>
    </div>
  `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }


        // —— 示例页：两视角 + prompt + 预填分数（禁用）+ 评分解析 —— //
        function rubricText(dim, score) {
            const T = {
                s1: {
                    1: "明显不自然，姿态僵硬或跳动（Jitter）。",
                    2: "局部僵硬、过渡不连贯，偶有异常姿势。",
                    3: "整体自然，轻微不协调，可接受。",
                    4: "流畅协调，基本符合生理逻辑。",
                    5: "极度自然，如真人表演，连续平滑。"
                },
                s2: {
                    1: "几乎无交互或交互模糊，意图不可辨。",
                    2: "有交互迹象但配合不足，目标模糊。",
                    3: "交互结构可辨，部分回应不到位。",
                    4: "交互明确，配合良好，有往返关系。",
                    5: "高度清晰、连贯，存在紧密回应链。"
                },
                s3: {
                    1: "多次明显肢体穿插或严重交错。",
                    2: "偶有穿插，站位常不合理（过近/过远）。",
                    3: "少量穿插发生在复杂动作中，整体尚可。",
                    4: "空间关系自然，无明显穿插，距离恰当。",
                    5: "完全无穿插，空间结构自然合理。"
                },
                s4: {
                    1: "与文本/场景严重不符，无法表达含义。",
                    2: "有部分契合点，但总体偏离主题。",
                    3: "大致符合，情境表达不够到位。",
                    4: "高度一致，语义清晰到位。",
                    5: "与描述精确匹配且富有张力、沉浸感强。"
                }
            };
            return T[dim]?.[score] || "";
        }

        function renderAnalysis(s) {
            const ex = s.explain;
            if (!ex) return '';                   // 没有 explain 就不显示解析模块

            // 仅渲染你写了的字段；没写的维度不出现
            const rows = [];
            if (ex.s1) rows.push(`<li><strong>动作自然性</strong>：${ex.s1}</li>`);
            if (ex.s2) rows.push(`<li><strong>多人互动清晰度</strong>：${ex.s2}</li>`);
            if (ex.s3) rows.push(`<li><strong>空间合理性与穿插控制</strong>：${ex.s3}</li>`);
            if (ex.s4) rows.push(`<li><strong>场景契合度</strong>：${ex.s4}</li>`);

            const hasList = rows.length > 0;
            const overall = ex.overall ? `<div style="margin-top:8px;"><strong>综合说明：</strong>${ex.overall}</div>` : '';

            // 如果四个维度都没写且只有 overall，就只显示 overall，不显示列表
            if (!hasList && overall) {
                return `
      <div class="analysis-box">
        <h3>评分解析</h3>
        ${overall}
      </div>
    `;
            }

            // 有写到某些维度，就显示列表；overall 有则追加
            if (hasList) {
                return `
      <div class="analysis-box">
        <h3>评分解析</h3>
        <ul>
          ${rows.join('')}
        </ul>
        ${overall}
      </div>
    `;
            }

            // 既没有维度、也没有 overall：不显示
            return '';
        }


        function renderRow(label, name, val) {
            const cells = [1, 2, 3, 4, 5].map(v => `<td><input type="radio" name="${name}" value="${v}" ${v === val ? 'checked' : ''} disabled></td>`).join('');
            return `<tr><td class="rowlabel">${label}</td>${cells}</tr>`;
        }

        function renderSample(idxInSamples) {
            const s = samples[idxInSamples];
            const bi = prompts[s.prompt_id] || {};
            const en = bi.en || '', zh = bi.zh || '';
            const avg = ((s.prefill.s1 + s.prefill.s2 + s.prefill.s3 + s.prefill.s4) / 4).toFixed(2);

            els.main.innerHTML = `
    <h2>${pages[current].title}</h2>
    <div class="video-grid">
      <div><div class="muted">视角 A</div><video controls preload="metadata" src="${s.camera_1}"></video></div>
      <div><div class="muted">视角 B</div><video controls preload="metadata" src="${s.camera_2}"></video></div>
    </div>
    <div class="prompt-box">
      <div class="muted">动作描述（Prompt）</div>
      <div>${en}${en && zh ? '<br>' : ''}${zh}</div>
    </div>
    <div class="matrix">
      <table>
        <thead><tr><th class="rowlabel"></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
        <tbody>
          ${renderRow('动作自然性', 's1', s.prefill.s1)}
          ${renderRow('多人互动清晰度', 's2', s.prefill.s2)}
          ${renderRow('空间合理性与穿插控制', 's3', s.prefill.s3)}
          ${renderRow('场景契合度', 's4', s.prefill.s4)}
        </tbody>
      </table>
    </div>
    <div class="avgbox">示例平均分：${avg}</div>
    ${renderAnalysis(s)}
    <div class="cta">
      ${current > 1 ? '<button class="btn" id="prev">上一页</button>' : ''}
      ${current < pages.length - 1 ? '<button class="btn" id="next">下一页</button>' : ''}
    </div>
  `;
            const prev = document.getElementById('prev');
            const next = document.getElementById('next');
            if (prev) prev.addEventListener('click', () => load(current - 1));
            if (next) next.addEventListener('click', () => load(current + 1));
        }


        // —— 共识测试：说明页 —— //
        function renderConsensusIntro() {
            els.main.innerHTML = `
      <h2>共识测试说明</h2>
      <p class="muted">请先完成以下 <strong>${consensus.length}</strong> 道共识测试题，这些题目对所有志愿者一致。每个题目完成后，请你点击保存当前评分，成功保存的题目左侧菜单栏会显示绿色表示完成。完成所有测试后请在“下载共识测试数据”页导出下载你的 CSV 文件并妥善保存，再进入正式评分。</p>
      <div class="cta">
        <button class="btn" id="goFirst">开始共识测试</button>
      </div>
    `;
            document.getElementById('goFirst').addEventListener('click', () => {
                const first = pages.findIndex(p => p.type === 'cons_task');
                load(first >= 0 ? first : pages.length - 1);
            });
        }

        // —— 共识测试：单题页（与正式评分布局一致，但仅存本地，不导出到正式CSV）—— //
        function renderConsensusTask(idxInConsensus) {
            const s = consensus[idxInConsensus];
            const bi = prompts[s.prompt_id] || {};
            const en = bi.en || '', zh = bi.zh || '';

            els.main.innerHTML = `
      <h2>${pages[current].title}</h2>
      <div class="video-grid">
        <div><div class="muted">视角 A</div><video controls preload="metadata" src="${s.camera_1}"></video></div>
        <div><div class="muted">视角 B</div><video controls preload="metadata" src="${s.camera_2}"></video></div>
      </div>
      <div class="prompt-box">
        <div class="muted">动作描述（Prompt）</div>
        <div>${en}${en && zh ? '<br>' : ''}${zh}</div>
      </div>

      <div class="matrix">
        <table>
          <thead><tr><th class="rowlabel"></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
          <tbody>
            ${[['动作自然性', 's1'], ['多人互动清晰度', 's2'], ['空间合理性与穿插控制', 's3'], ['场景契合度', 's4']]
                .map(([label, name]) => `<tr><td class="rowlabel">${label}</td>
                  ${[1, 2, 3, 4, 5].map(v => `<td><input type="radio" name="${name}" value="${v}"></td>`).join('')}
                </tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="avgbox">平均分：<span id="cavg">—</span></div>

      <div class="cta">
        ${current > 0 ? '<button class="btn" id="prev">上一题</button>' : ''}
        <button class="btn" id="save">保存当前评分</button>
        ${current < pages.length - 1 ? '<button class="btn" id="next">下一题</button>' : ''}
      </div>
    `;

            function getSel(n) {
                const x = els.main.querySelector(`input[name="${n}"]:checked`);
                return x ? Number(x.value) : NaN;
            }

            function setSel(n, val) {
                els.main.querySelectorAll(`input[name="${n}"]`).forEach(r => r.checked = (Number(r.value) === Number(val)));
            }

            function calcAvg() {
                const vs = ['s1', 's2', 's3', 's4'].map(getSel);
                els.main.querySelector('#cavg').textContent = vs.every(v => !Number.isNaN(v)) ? (vs.reduce((a, b) => a + b, 0) / 4).toFixed(2) : '—';
            }

            els.main.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', calcAvg));

            // 恢复该题已保存
            const prev = consResults.get(s.video_id);
            if (prev) {
                setSel('s1', prev.s1);
                setSel('s2', prev.s2);
                setSel('s3', prev.s3);
                setSel('s4', prev.s4);
            }
            calcAvg();

            // 保存当前题
            els.main.querySelector('#save').addEventListener('click', () => {
                const s1 = getSel('s1'), s2 = getSel('s2'), s3 = getSel('s3'), s4 = getSel('s4');
                if ([s1, s2, s3, s4].some(v => Number.isNaN(v))) {
                    alert('请完成4项评分再保存。');
                    return;
                }
                const avg = Number(els.main.querySelector('#cavg').textContent);
                const saved_at = new Date().toISOString();
                consResults.set(s.video_id, {video_id: s.video_id, s1, s2, s3, s4, avg, saved_at});

                // 本地续存（跨重启）
                const obj = {};
                for (const [k, v] of consResults.entries()) obj[k] = v;
                localStorage.setItem(CONS_KEY, JSON.stringify(obj));

                // 按钮反馈 + 左侧目录着色 + 顶部进度
                const btn = els.main.querySelector('#save');
                btn.textContent = '已保存 ✓';
                setTimeout(() => btn.textContent = '保存当前评分', 800);
                updateIndexDoneStates();
                updateMeta();
            });

            const prevBtn = els.main.querySelector('#prev');
            const nextBtn = els.main.querySelector('#next');
            if (prevBtn) prevBtn.addEventListener('click', () => load(current - 1));
            if (nextBtn) nextBtn.addEventListener('click', () => load(current + 1));
        }

        // —— 共识测试：导出页（下载 CSV 后再进入正式评分）—— //
        function renderConsensusExport() {
            els.main.innerHTML = `
    <h2>共识测试完成</h2>
    <p class="muted">你已完成共识测试：<strong>${consResults.size}/${consensus.length}</strong>。请点击下方按钮导出并保存你的共识测试评分 CSV 文件，然后进入正式评分（新窗口）。</p>
    <div class="cta">
      <button class="btn" id="prev">上一页</button>
      <button class="btn" id="exportCons">导出共识测试 CSV</button>
      <button class="btn" id="next">下一页</button>
    </div>
  `;

            // 按钮绑定
            document.getElementById('exportCons').addEventListener('click', () => {
                if (consResults.size < consensus.length) {
                    const missing = [];
                    const byId = new Map(consensus.map((t, idx) => [t.video_id, idx + 1]));
                    for (const t of consensus) {
                        if (!consResults.has(t.video_id)) missing.push(byId.get(t.video_id));
                        if (missing.length >= 10) break;
                    }
                    alert(`还有 ${consensus.length - consResults.size} 道未评分（示例题号）：\n` + missing.join(', '));
                    return;
                }
                const header = ['user', 'video_id', 's1', 's2', 's3', 's4', 'avg'];
                const rows = [header.join(',')];
                for (const t of consensus) {
                    const r = consResults.get(t.video_id);
                    rows.push([user, r.video_id, r.s1, r.s2, r.s3, r.s4, r.avg].join(','));
                }
                const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${user}_consensus_ratings.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            });

            document.getElementById('prev').addEventListener('click', () => load(current - 1));
            document.getElementById('next').addEventListener('click', () => load(current + 1));
        }


        // —— 最后一页：开始正式评分 —— //
        function renderStart() {
            els.main.innerHTML = `
      <h2>培训完成</h2>
      <p class="muted">你已阅读评分标准、查看示例，并完成共识测试。请在新窗口打开正式评分页面，培训页会保留，方便随时对照标准。</p>
      <div class="cta">
        <a class="btn" target="_blank" href="index.html?user=${encodeURIComponent(user)}">开启正式评分（新窗口）</a>
        <button class="btn" id="back">返回上一页</button>
      </div>
    `;
            document.getElementById('back').addEventListener('click', () => load(current - 1));
        }

        // —— 页面分发 —— //
        function load(idx) {
            current = Math.max(0, Math.min(idx, pages.length - 1));
            setActive(current);
            updateMeta();
            const p = pages[current];
            if (p.type === 'welcome') renderWelcome();
            else if (p.type === 'standard') renderStandard();
            else if (p.type === 'notice') renderNotice();
            else if (p.type === 'sample') renderSample(current - 1); // 样例从索引0开始
            else if (p.type === 'cons_intro') renderConsensusIntro();
            else if (p.type === 'cons_task') renderConsensusTask(p.idx);
            else if (p.type === 'cons_export') renderConsensusExport();
            else if (p.type === 'start') renderStart();
        }

        // —— 加载数据：示例、prompt 双语、固定的共识题清单 —— //
        Promise.all([
            fetch('data/training_samples.json', {cache: 'no-store'}).then(r => r.json()),
            fetch('data/prompts_bi.json', {cache: 'no-store'}).then(r => r.json()).catch(() => ({})),
            fetch('data/consensus_test.json', {cache: 'no-store'}).then(r => r.json())
        ]).then(([smps, pmap, cons]) => {
            samples = smps || [];
            prompts = pmap || {};
            consensus = cons || [];

            // 恢复共识本地存档
            try {
                const raw = localStorage.getItem(CONS_KEY);
                if (raw) {
                    const obj = JSON.parse(raw);
                    Object.values(obj).forEach(r => consResults.set(r.video_id, r));
                }
            } catch (e) {
                console.warn('consensus localStorage 恢复失败', e);
            }

            // 在“示例”之后依次追加：共识说明 -> N个共识题 -> 共识导出 -> 开始正式评分
            pages.push({type: 'cons_intro', title: '共识测试说明'});
            consensus.forEach((item, idx) => pages.push({type: 'cons_task', title: `共识测试 ${idx + 1}`, idx}));
            pages.push({type: 'cons_export', title: '下载共识测试数据'});
            pages.push({type: 'start', title: '开始正式评分'});

            renderIndex();
            load(0);
        }).catch(err => {
            alert('加载培训数据失败：' + err.message);
            console.error(err);
        });

    })();
</script>
</body>
</html>
