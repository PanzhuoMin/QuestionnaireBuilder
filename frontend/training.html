<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>多人动作评分 · 实验准备</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 16px;
        }

        .wrap {
            width: 100%;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .meta {
            color: #666;
            margin-bottom: 16px;
        }

        /* 两列布局：左侧目录窄，右侧内容宽 */
        .layout {
            display: grid;
            grid-template-columns:160px 1fr;
            gap: 16px;
        }

        /* 侧边目录 */
        .sidebar {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .sidebar header {
            padding: 10px 12px;
            background: #f7f7f7;
            font-weight: 600;
        }

        .sidebar .list {
            max-height: calc(100vh - 150px);
            overflow: auto;
            padding: 8px;
        }

        .idxbtn {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            border: 1px solid #eee;
            background: #fff;
            color: #000;
            border-radius: 6px;
            margin: 4px 0;
            cursor: pointer;
            font-size: 14px;
        }

        .idxbtn.active {
            outline: 2px solid #222;
        }

        .idxbtn.done {
            background: #e9f7ef;
            border-color: #bfe7cf;
        }

        /* 完成=绿色 */

        /* 视频区域更大，便于观看 */
        .video-grid {
            display: grid;
            grid-template-columns:1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }

        video {
            width: 100%;
            height: auto;
            max-height: 420px;
            background: #000;
        }

        .prompt-box {
            background: #fafafa;
            border: 1px solid #eee;
            padding: 12px;
            margin: 12px 0 18px;
            white-space: pre-wrap;
        }

        .muted {
            color: #777;
            font-size: 13px;
        }

        .matrix {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .matrix table {
            width: 100%;
            border-collapse: collapse;
        }

        .matrix th, .matrix td {
            border-bottom: 1px solid #eee;
            text-align: center;
            padding: 10px;
        }

        .matrix tr:last-child td {
            border-bottom: none;
        }

        .matrix thead th {
            background: #f7f7f7;
            font-weight: 600;
            color: #444;
        }

        .rowlabel {
            text-align: left;
            width: 240px;
            color: #444;
        }

        .avgbox {
            margin: 8px 0;
            font-weight: 600;
        }

        /* 评分标准表 */
        .std-table {
            width: 100%;
            border-collapse: collapse;
        }

        .std-table th, .std-table td {
            border: 1px solid #ddd;
            padding: 10px;
            vertical-align: top;
        }

        .std-table thead th {
            background: #f2f2f2;
        }

        .std-ename {
            color: #888;
            font-size: 12px;
            font-weight: normal;
            margin-left: 6px;
        }

        .cta {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            background: #222;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        /* 示例评分解析 */
        .analysis-box {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
            background: #fcfcfc;
        }

        .analysis-box h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .analysis-box ul {
            margin: 0;
            padding-left: 18px;
        }

        .analysis-box li {
            margin: 6px 0;
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1>多人动作评分 · 实验准备</h1>
    <div class="meta" id="metaInfo">请先阅读评分标准与注意事项，并阅读 5
        个典型示例；完成后进行共识测试并下载数据，再进入正式评分。
    </div>

    <div class="layout">
        <!-- 左侧目录 -->
        <aside class="sidebar">
            <header>培训目录</header>
            <div class="list" id="idxList"></div>
        </aside>

        <!-- 右侧主体 -->
        <main id="main"><!-- 动态渲染 --></main>
    </div>
</div>

<script>
    (function () {
        const params = new URLSearchParams(location.search);
        const user = params.get('user') || 'user_001';

        // 先只放固定页，示例页与共识页等数据加载后再动态追加
        const pages = [
            {type: 'welcome', title: '欢迎'},
            {type: 'standard', title: '评分标准表'},
            {type: 'notice', title: '注意事项'}
        ];

        const els = {
            idxList: document.getElementById('idxList'),
            main: document.getElementById('main'),
            meta: document.getElementById('metaInfo')
        };

        let samples = [];   // data/training_samples.json
        let prompts = {};   // data/prompts_bi.json
        let consensus = []; // data/consensus_test.json

        let current = 0;

        // —— 共识测试评分：本地续存（跨重启不丢）——
        const CONS_KEY = `consensus_${user}`;
        // 新逻辑：以“唯一 key（video_id#index）”为键，避免重复题覆盖
        const consResults = new Map(); // key -> {key,cons_index,video_id,repeat_of,s1..s4,avg,saved_at}
        function consKeyByIndex(i) {
            const t = consensus[i];
            return `${t.video_id}#${i}`;
        }

        // —— 侧边目录 —— //
        function renderIndex() {
            const frag = document.createDocumentFragment();
            pages.forEach((p, idx) => {
                const b = document.createElement('button');
                b.className = 'idxbtn' + (idx === current ? ' active' : '');
                b.textContent = `${idx + 1}. ${p.title}`;

                // 共识题完成着色
                if (p.type === 'cons_task') {
                    const k = consKeyByIndex(p.idx);
                    if (consResults.has(k)) b.classList.add('done');
                }

                b.addEventListener('click', () => load(idx));
                frag.appendChild(b);
            });
            els.idxList.innerHTML = '';
            els.idxList.appendChild(frag);
        }

        function setActive(idx) {
            els.idxList.querySelectorAll('.idxbtn').forEach((b, i) => b.classList.toggle('active', i === idx));
        }

        function updateIndexDoneStates() {
            const btns = els.idxList.querySelectorAll('.idxbtn');
            pages.forEach((p, idx) => {
                if (p.type === 'cons_task') {
                    const k = consKeyByIndex(p.idx);
                    btns[idx]?.classList.toggle('done', consResults.has(k));
                }
            });
        }

        // —— 顶部进度提示 —— //
        function updateMeta() {
            const p = pages[current];
            if (p.type === 'cons_task' || p.type === 'cons_intro' || p.type === 'cons_export') {
                const doneCount = consensus.reduce((acc, _, i) => acc + (consResults.has(consKeyByIndex(i)) ? 1 : 0), 0);
                els.meta.innerHTML = `共识测试进度：<strong>${doneCount}/${consensus.length}</strong>（已完成/总数）。`;
            } else {
                els.meta.textContent = `请先阅读评分标准与注意事项，并阅读 ${samples.length || '若干'} 个典型示例；完成后进行共识测试并下载数据，再进入正式评分。`;
            }
        }

        // —— 欢迎页 —— //
        function renderWelcome() {
            els.main.innerHTML = `
      <h2>欢迎参加「多人动作评分」实验</h2>
      <p>感谢你参与本次研究！本实验旨在评估与改进多人动作生成模型的感知质量。目标是让模型生成的动作更自然、更流畅且更符合人类直觉与生理常识，尤其是在多人互动场景中的配合与空间合理性。</p>

      <h3>实验流程</h3>
      <ol>
        <li><strong>评分标准表：</strong>先了解四个评分维度及其 1–5 分的定义。</li>
        <li><strong>注意事项：</strong>了解保存方式、浏览器要求与数据备份。</li>
        <li><strong>示例学习：</strong>观看${samples.length || '若干'}个示例（双视角），对照示例评分与解析，快速熟悉标准。</li>
        <li><strong>共识测试：</strong>完成统一的 19 道共识测试（含重复题），并下载保存 CSV 结果。</li>
        <li><strong>正式评分：</strong>进入正式任务，对分配给你的动作样本进行评分并导出 CSV。</li>
      </ol>

      <h3>我们的研究与数据集贡献</h3>
      <p>现有自动指标与人类感知并不完全一致，难以全面反映动作质量。本研究通过大规模人类感知反馈建立数据集，并训练<strong>人感知对齐的动作评论模型（MotionCritic）</strong>，使其作为更符合人类判断的质量度量，并可用作生成模型的轻量监督信号，以提升生成质量。你的评分将直接帮助我们构建<strong>多人动作</strong>的感知数据，为未来的动作生成研究与评测提供更可靠的参考。</p>

      <p><em>再次感谢你的参与！你的认真评分将帮助学界更准确地评价和改进动作生成模型。</em></p>

      <div class="cta">
        <button class="btn" id="toNext">下一页：评分标准表</button>
      </div>
    `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }

        // —— 评分标准表（含维度解释） —— //
        function renderStandard() {
            els.main.innerHTML = `
      <h2>评分标准表</h2>
      <table class="std-table">
        <thead>
          <tr><th>评分维度</th><th>1 分</th><th>2 分</th><th>3 分</th><th>4 分</th><th>5 分</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>动作自然性 <span class="std-ename">Motion Naturalness</span></td>
            <td>明显不自然、断裂/跳变、严重抖动（像机器人）。</td>
            <td>局部僵硬、过渡不连贯，偶有异常姿势。</td>
            <td>整体尚自然，轻微不协调可接受。</td>
            <td>流畅协调，基本符合生理逻辑。</td>
            <td>极度自然、连续平滑、细节丰富。</td>
          </tr>
          <tr>
            <td>多人互动清晰度 <span class="std-ename">Interaction Clarity</span></td>
            <td>几乎无互动或互动模糊，意图不可辨。</td>
            <td>有互动迹象但配合不足，目标模糊。</td>
            <td>互动结构可辨，部分回应不到位。</td>
            <td>互动明确、配合良好，有因果链。</td>
            <td>高度清晰、连贯，回应紧密。</td>
          </tr>
          <tr>
            <td>空间合理性与穿插控制 <span class="std-ename">Spatial Plausibility & Penetration</span></td>
            <td>多次明显穿插/重叠/错位。</td>
            <td>偶有穿插，站位常不合理。</td>
            <td>少量穿插（多见复杂动作），整体可接受。</td>
            <td>空间自然、距离恰当，无明显穿插。</td>
            <td>完全无穿插，空间布局精准自然。</td>
          </tr>
          <tr>
            <td>场景契合度 <span class="std-ename">Scene / Prompt Relevance</span></td>
            <td>与描述严重不符，语义缺失明显。</td>
            <td>部分契合但总体偏离主题。</td>
            <td>大致符合，关键点不够到位。</td>
            <td>高度一致，语义清晰到位。</td>
            <td>精确匹配且富有节奏/情绪张力。</td>
          </tr>
        </tbody>
      </table>

      <div class="analysis-box" style="margin-top:16px">
        <h3>评分维度详细解释(仅供参考)</h3>

        <h4>1) 动作自然性（评价动作本身的生物学合理性与流畅性）</h4>
        <ul>
          <li><strong>看点：</strong>是否“有意图的运动”；关节转动是否合逻辑；过渡是否平滑。</li>
          <li><strong>常见扣分：</strong>断裂/突然跳变；严重抖动（头部轻微抖动可宽容）；僵硬像木偶；脚步平移无屈膝；随机挥舞。</li>
          <li><strong>加分线索：</strong>连贯顺滑、姿势自然；手臂随动/转头等细节；整体接近真人演示。</li>
          <li><strong>注意：</strong>根据不自然程度来判断，例如轻微抖动可只降 1 分。</li>
        </ul>

        <h4>2) 多人互动清晰度（是否能看出明确互动或良好区分）</h4>
        <ul>
          <li><strong>看点：</strong>面对面/攻防/传接等是否清晰，有无因果链或配合关系。</li>
          <li><strong>常见扣分：</strong>应有互动却“各跳各的”；有对视无回应；不知谁与谁互动。</li>
          <li><strong>加分线索：</strong>“攻击–闪避”“握手”“传–接”等明确响应；无需互动的场景下，两人动作也清楚不干扰。</li>
          <li><strong>注意：</strong>Prompt 不要求互动时，不要强行打低分；具体例子可参考示例。</li>
        </ul>

        <h4>3) 空间合理性与穿插控制（距离/站位/是否穿插）</h4>
        <ul>
          <li><strong>看点：</strong>对打/舞蹈的安全距离与间隔；角色之间是否穿插、重叠、错位。</li>
          <li><strong>常见扣分：</strong>手臂穿过身体/对方；身体重叠；脚插地或插对方；位置极不合理；频繁穿插。</li>
          <li><strong>加分线索：</strong>距离合适、布局自然；完全无穿插；协调程度像真实表演。</li>
          <li><strong>注意：</strong>复杂动作少量穿插可接受（≈3 分）；若整体合理仅个别手指/脚尖轻微穿插，可从 4 调至 3。</li>
        </ul>

        <h4>4) 场景契合度（是否符合文本描述/角色分工）</h4>
        <ul>
          <li><strong>看点：</strong>动作是否与描述一致，是否避免与 prompt 冲突；多要素是否分别落实。</li>
          <li><strong>常见扣分：</strong>严重不符；只完成部分语义；两人混乱（该甲做的动作却乙在做）。</li>
          <li><strong>加分线索：</strong>覆盖主要语义点；关键动作一目了然；还体现节奏/情绪张力。</li>
          <li><strong>注意：</strong>与自然性独立：自然不代表契合；多要素要逐一检查是否到位。</li>
        </ul>

        <h4>评审提醒</h4>
        <p>四个维度<strong>相互独立</strong>。请不要被“整体感觉”带偏：</p>
        <ul>
          <li>自然性 = 5，但无互动 → 互动清晰度仍应打低分（如 1）。</li>
          <li>契合度 = 5，但有严重穿插 → 空间合理性应打低分（如 1）。</li>
        </ul>
      </div>

      <div class="cta">
        <button class="btn" id="toNext">下一页：注意事项</button>
      </div>
    `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }

        // —— 注意事项 —— //
        function renderNotice() {
            els.main.innerHTML = `
      <h2>注意事项</h2>
      <ol>
        <li>页面提供中英文双语描述。中文为机器翻译，可能不准确，请以英文为准。</li>
        <li>完成每个样本评分后，请务必点击 <strong>“保存当前评分”</strong>。</li>
        <li>评分结果保存在本地浏览器；可随时关闭页面或电脑，但请不要清除浏览器数据，也不要在无痕模式下访问。</li>
        <li>完成共识测试与正式实验后，请分别下载并妥善保存生成的 CSV 文件。</li>
      </ol>
      <div class="cta"><button class="btn" id="toNext">下一页：示例 1</button></div>
    `;
            document.getElementById('toNext').addEventListener('click', () => load(current + 1));
        }

        // —— 示例页（双视角 + 预填分 + 你的自定义解析）—— //
        function renderAnalysis(s) {
            const ex = s.explain;
            if (!ex) return '';
            const rows = [];
            if (ex.s1) rows.push(`<li><strong>动作自然性</strong>：${ex.s1}</li>`);
            if (ex.s2) rows.push(`<li><strong>多人互动清晰度</strong>：${ex.s2}</li>`);
            if (ex.s3) rows.push(`<li><strong>空间合理性与穿插控制</strong>：${ex.s3}</li>`);
            if (ex.s4) rows.push(`<li><strong>场景契合度</strong>：${ex.s4}</li>`);
            const hasList = rows.length > 0;
            const overall = ex.overall ? `<div style="margin-top:8px;"><strong>综合说明：</strong>${ex.overall}</div>` : '';
            if (!hasList && overall) {
                return `<div class="analysis-box"><h3>评分解析</h3>${overall}</div>`;
            }
            if (hasList) {
                return `<div class="analysis-box"><h3>评分解析</h3><ul>${rows.join('')}</ul>${overall}</div>`;
            }
            return '';
        }

        function renderRow(label, name, val) {
            const cells = [1, 2, 3, 4, 5].map(v => `<td><input type="radio" name="${name}" value="${v}" ${v === val ? 'checked' : ''} disabled></td>`).join('');
            return `<tr><td class="rowlabel">${label}</td>${cells}</tr>`;
        }

        function renderSample(idx) {
            const s = samples[idx];
            const bi = prompts[s.prompt_id] || {};
            const en = bi.en || '', zh = bi.zh || '';
            const avg = ((s.prefill.s1 + s.prefill.s2 + s.prefill.s3 + s.prefill.s4) / 4).toFixed(2);
            els.main.innerHTML = `
      <h2>${pages[current].title}</h2>
      <div class="video-grid">
        <div><div class="muted">视角 A</div><video controls preload="metadata" src="${s.camera_1}"></video></div>
        <div><div class="muted">视角 B</div><video controls preload="metadata" src="${s.camera_2}"></video></div>
      </div>
      <div class="prompt-box">
        <div class="muted">动作描述（Prompt）</div>
        <div>${en}${en && zh ? '<br>' : ''}${zh}</div>
      </div>
      <div class="matrix">
        <table>
          <thead><tr><th class="rowlabel"></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
          <tbody>
            ${renderRow('动作自然性', 's1', s.prefill.s1)}
            ${renderRow('多人互动清晰度', 's2', s.prefill.s2)}
            ${renderRow('空间合理性与穿插控制', 's3', s.prefill.s3)}
            ${renderRow('场景契合度', 's4', s.prefill.s4)}
          </tbody>
        </table>
      </div>
      <div class="avgbox">示例平均分：${avg}</div>
      ${renderAnalysis(s)}
      <div class="cta">
        ${current > 0 ? '<button class="btn" id="prev">上一页</button>' : ''}
        ${current < pages.length - 1 ? '<button class="btn" id="next">下一页</button>' : ''}
      </div>
    `;
            const prev = document.getElementById('prev');
            const next = document.getElementById('next');
            if (prev) prev.addEventListener('click', () => load(current - 1));
            if (next) next.addEventListener('click', () => load(current + 1));
        }

        // —— 共识测试：说明 —— //
        function renderConsensusIntro() {
            els.main.innerHTML = `
      <h2>共识测试说明</h2>
      <p class="muted">请先完成以下 <strong>${consensus.length}</strong> 道共识测试题（含 3 道重复题用于一致性评估）。每题完成后请点击“保存当前评分”；左侧目录会以绿色标记完成。完成所有测试后，请在“下载共识测试数据”页导出 CSV 并妥善保存，再进入正式评分。</p>
      <div class="cta"><button class="btn" id="goFirst">开始共识测试</button></div>
    `;
            document.getElementById('goFirst').addEventListener('click', () => {
                const first = pages.findIndex(p => p.type === 'cons_task');
                load(first >= 0 ? first : pages.length - 1);
            });
        }

        // —— 共识测试：单题页 —— //
        function renderConsensusTask(idxInConsensus) {
            const s = consensus[idxInConsensus];
            const bi = prompts[s.prompt_id] || {};
            const en = bi.en || '', zh = bi.zh || '';
            const key = consKeyByIndex(idxInConsensus);

            els.main.innerHTML = `
      <h2>${pages[current].title}</h2>
      <div class="video-grid">
        <div><div class="muted">视角 A</div><video controls preload="metadata" src="${s.camera_1}"></video></div>
        <div><div class="muted">视角 B</div><video controls preload="metadata" src="${s.camera_2}"></video></div>
      </div>
      <div class="prompt-box">
        <div class="muted">动作描述（Prompt）</div>
        <div>${en}${en && zh ? '<br>' : ''}${zh}</div>
      </div>

      <div class="matrix">
        <table>
          <thead><tr><th class="rowlabel"></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
          <tbody>
            ${[['动作自然性', 's1'], ['多人互动清晰度', 's2'], ['空间合理性与穿插控制', 's3'], ['场景契合度', 's4']]
                .map(([label, name]) => `<tr><td class="rowlabel">${label}</td>${[1, 2, 3, 4, 5].map(v => `<td><input type="radio" name="${name}" value="${v}"></td>`).join('')}</tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="avgbox">平均分：<span id="cavg">—</span></div>

      <div class="cta">
        ${current > 0 ? '<button class="btn" id="prev">上一题</button>' : ''}
        <button class="btn" id="save">保存当前评分</button>
        ${current < pages.length - 1 ? '<button class="btn" id="next">下一题</button>' : ''}
      </div>
    `;

            function getSel(n) {
                const x = els.main.querySelector(`input[name="${n}"]:checked`);
                return x ? Number(x.value) : NaN;
            }

            function setSel(n, val) {
                els.main.querySelectorAll(`input[name="${n}"]`).forEach(r => r.checked = (Number(r.value) === Number(val)));
            }

            function calcAvg() {
                const vs = ['s1', 's2', 's3', 's4'].map(getSel);
                els.main.querySelector('#cavg').textContent = vs.every(v => !Number.isNaN(v)) ? (vs.reduce((a, b) => a + b, 0) / 4).toFixed(2) : '—';
            }

            els.main.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', calcAvg));

            // 恢复该题已保存
            const prev = consResults.get(key);
            if (prev) {
                setSel('s1', prev.s1);
                setSel('s2', prev.s2);
                setSel('s3', prev.s3);
                setSel('s4', prev.s4);
            }
            calcAvg();

            // 保存当前题
            els.main.querySelector('#save').addEventListener('click', () => {
                const s1 = getSel('s1'), s2 = getSel('s2'), s3 = getSel('s3'), s4 = getSel('s4');
                if ([s1, s2, s3, s4].some(v => Number.isNaN(v))) {
                    alert('请完成4项评分再保存。');
                    return;
                }
                const avg = Number(els.main.querySelector('#cavg').textContent);
                const saved_at = new Date().toISOString();

                const record = {
                    key,
                    cons_index: idxInConsensus + 1, // 1-based 题号
                    video_id: s.video_id,
                    repeat_of: s.repeat_of || '',   // 若为重复题则有值
                    s1, s2, s3, s4, avg, saved_at
                };
                consResults.set(key, record);

                // 本地续存（跨重启）
                const obj = {};
                for (const [k, v] of consResults.entries()) obj[k] = v;
                localStorage.setItem(CONS_KEY, JSON.stringify(obj));

                const btn = els.main.querySelector('#save');
                btn.textContent = '已保存 ✓';
                setTimeout(() => btn.textContent = '保存当前评分', 800);
                updateIndexDoneStates();
                updateMeta();
            });

            const prevBtn = els.main.querySelector('#prev');
            const nextBtn = els.main.querySelector('#next');
            if (prevBtn) prevBtn.addEventListener('click', () => load(current - 1));
            if (nextBtn) nextBtn.addEventListener('click', () => load(current + 1));
        }

        // —— 共识测试：导出页 —— //
        function renderConsensusExport() {
            const doneCount = consensus.reduce((acc, _, i) => acc + (consResults.has(consKeyByIndex(i)) ? 1 : 0), 0);
            els.main.innerHTML = `
      <h2>共识测试完成</h2>
      <p class="muted">你已完成共识测试：<strong>${doneCount}/${consensus.length}</strong>。请点击下方按钮导出并保存你的共识测试评分 CSV 文件，然后进入正式评分（新窗口）。</p>
      <div class="cta">
        <button class="btn" id="prev">上一页</button>
        <button class="btn" id="exportCons">导出共识测试 CSV</button>
        <button class="btn" id="next">下一页</button>
        <a class="btn" target="_blank" href="index.html?user=${encodeURIComponent(user)}">打开正式评分（新窗口）</a>
      </div>
    `;

            document.getElementById('exportCons').addEventListener('click', () => {
                const missing = [];
                for (let i = 0; i < consensus.length; i++) {
                    if (!consResults.has(consKeyByIndex(i))) missing.push(i + 1);
                }
                if (missing.length) {
                    alert(`还有 ${missing.length} 道未评分（示例题号）：\n` + missing.slice(0, 10).join(', '));
                    return;
                }
                const header = ['user', 'cons_index', 'video_id', 'repeat_of', 's1', 's2', 's3', 's4', 'avg'];
                const rows = [header.join(',')];
                for (let i = 0; i < consensus.length; i++) {
                    const k = consKeyByIndex(i);
                    const r = consResults.get(k);
                    rows.push([user, r.cons_index, r.video_id, r.repeat_of || '', r.s1, r.s2, r.s3, r.s4, r.avg].join(','));
                }
                const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${user}_consensus_ratings.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            });

            document.getElementById('prev').addEventListener('click', () => load(current - 1));
            document.getElementById('next').addEventListener('click', () => load(current + 1));
        }

        // —— 最后一页 —— //
        function renderStart() {
            els.main.innerHTML = `
      <h2>培训完成</h2>
      <p class="muted">你已阅读评分标准、查看示例，并完成共识测试。请在新窗口打开正式评分页面，培训页会保留，方便随时对照标准。</p>
      <div class="cta">
        <a class="btn" target="_blank" href="index.html?user=${encodeURIComponent(user)}">开启正式评分（新窗口）</a>
        <button class="btn" id="back">返回上一页</button>
      </div>
    `;
            document.getElementById('back').addEventListener('click', () => load(current - 1));
        }

        // —— 页面分发 —— //
        function load(idx) {
            current = Math.max(0, Math.min(idx, pages.length - 1));
            setActive(current);
            updateMeta();
            const p = pages[current];
            if (p.type === 'welcome') renderWelcome();
            else if (p.type === 'standard') renderStandard();
            else if (p.type === 'notice') renderNotice();
            else if (p.type === 'sample') renderSample(p.idx);          // ★ 用显式 idx，避免 current 偏移
            else if (p.type === 'cons_intro') renderConsensusIntro();
            else if (p.type === 'cons_task') renderConsensusTask(p.idx);
            else if (p.type === 'cons_export') renderConsensusExport();
            else if (p.type === 'start') renderStart();
        }

        // —— 加载数据：示例/双语 prompt/共识清单 —— //
        Promise.all([
            fetch('data/training_samples.json', {cache: 'no-store'}).then(r => r.json()),
            fetch('data/prompts_bi.json', {cache: 'no-store'}).then(r => r.json()).catch(() => ({})),
            fetch('data/consensus_test.json', {cache: 'no-store'}).then(r => r.json())
        ]).then(([smps, pmap, cons]) => {
            samples = smps || [];
            prompts = pmap || {};
            consensus = cons || [];

            // 动态把“示例页”加入目录（按 JSON 数量）
            samples.forEach((_, i) => pages.push({type: 'sample', title: `示例 ${i + 1}`, idx: i}));

            // 恢复共识本地存档（兼容老版本）
            try {
                const raw = localStorage.getItem(CONS_KEY);
                if (raw) {
                    const obj = JSON.parse(raw);
                    Object.values(obj).forEach(r => {
                        const k = r.key || null;
                        if (k) consResults.set(k, r); // 新版：带 key
                        // 旧版（仅 video_id）不做迁移，避免重复题错配；让用户重新保存重复题即可
                    });
                }
            } catch (e) {
                console.warn('consensus localStorage 恢复失败', e);
            }

            // 再追加：共识说明 -> N道共识题 -> 下载导出 -> 开始正式评分
            pages.push({type: 'cons_intro', title: '共识测试说明'});
            consensus.forEach((_, idx) => pages.push({type: 'cons_task', title: `共识测试 ${idx + 1}`, idx}));
            pages.push({type: 'cons_export', title: '下载共识测试数据'});
            pages.push({type: 'start', title: '开始正式评分'});

            renderIndex();
            load(0);
        }).catch(err => {
            alert('加载培训数据失败：' + err.message);
            console.error(err);
        });

    })();
</script>

</body>
</html>

